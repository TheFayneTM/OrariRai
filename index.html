<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RAI Shift Calendar Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
            font-size: 14px;
        }

        input[type="text"],
        input[type="file"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="file"]:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-bottom: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        button.secondary {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            display: none;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
            display: block;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .shifts-preview {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 2px solid #667eea;
            display: none;
        }

        .shifts-preview.active {
            display: block;
        }

        .shifts-preview h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .shift-item {
            padding: 10px;
            margin: 8px 0;
            background: white;
            border-radius: 5px;
            border-left: 4px solid #667eea;
        }

        .shift-item strong {
            color: #667eea;
        }

        .debug {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìÖ RAI Shift Calendar Generator</h1>
        <p class="subtitle">Genera il tuo calendario turni in formato ICS</p>

        <div id="uploadSection">
            <div class="form-group">
                <label for="pdfFile">Carica il PDF dell'orario:</label>
                <input type="file" id="pdfFile" accept=".pdf" required>
            </div>

            <div class="form-group">
                <label for="firstName">Nome:</label>
                <input type="text" id="firstName" placeholder="es. Marco" required>
            </div>

            <div class="form-group">
                <label for="lastName">Cognome:</label>
                <input type="text" id="lastName" placeholder="es. Natalizi" required>
            </div>

            <button type="button" id="extractBtn">Estrai Turni dal PDF</button>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p style="margin-top: 10px; color: #666;">Elaborazione in corso...</p>
        </div>

        <div class="status" id="status"></div>

        <div class="shifts-preview" id="shiftsPreview">
            <h3>‚úÖ Turni Trovati:</h3>
            <div id="shiftsList"></div>
            <button type="button" id="downloadBtn" class="secondary">‚¨áÔ∏è Scarica Calendario ICS</button>
        </div>

        <div style="margin-top: 20px;">
            <h3 style="color: #333; font-size: 16px; margin-bottom: 10px;">üîç Debug Log:</h3>
            <div class="debug" id="debug">Waiting for action...</div>
        </div>
    </div>

    <script>
        // Set PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // Global variables
        let extractedSchedule = null;
        let currentFirstName = '';
        let currentLastName = '';

        const SHIFT_TIMES = {
            '4o': ['05:55', '13:30'], '5o': ['05:55', '14:30'], '01': ['05:45', '14:20'],
            '05': ['05:55', '14:30'], '14': ['12:15', '20:50'], '57': ['11:25', '19:00'],
            '5T': ['13:00', '20:35'], '1M': ['09:30', '18:05'], '2E': ['11:25', '20:00'],
            '2Q': ['14:00', '22:35'], '3Z': ['07:30', '16:05'], '6E': ['05:30', '13:05'],
            '6L': ['12:00', '19:35'], '7N': ['15:25', '23:00'], 'B1': ['05:50', '14:25'],
            'C': ['07:00', '15:35'], 'C*': ['07:00', '14:35'], 'Ce*': ['07:00', '14:35'],
            'D': ['08:00', '16:35'], 'D*': ['08:00', '15:35'], 'De*': ['08:00', '15:35'],
            'E': ['08:30', '17:05'], 'E*': ['08:30', '16:05'], 'EZ': ['10:25', '19:00'],
            'F': ['09:00', '17:35'], 'F*': ['09:00', '16:35'], 'Fe*': ['09:00', '16:35'],
            'F0': ['08:25', '17:00'], 'FH': ['08:25', '16:00'], 'G': ['10:00', '18:35'],
            'G*': ['10:00', '17:35'], 'G+': ['11:00', '18:35'], 'H': ['11:00', '19:30'],
            'I': ['12:45', '21:20'], 'I*': ['12:45', '20:20'], 'L': ['13:30', '22:05'],
            'L*': ['13:30', '21:05'], 'L+': ['14:30', '22:05'], 'M': ['15:00', '23:35'],
            'M*': ['15:00', '22:35'], 'M+': ['16:00', '23:35'], 'N': ['15:55', '00:30'],
            'N+': ['16:55', '00:30'], 'N1': ['16:25', '01:00'], 'O': ['16:55', '01:30'],
            'RC': ['05:30', '14:05'], 'RG': ['12:00', '20:35'], 'RU': ['05:00', '13:35'],
            'SR': ['10:45', '19:20'], 'TC': ['06:30', '15:05'], 'TD': ['06:30', '14:05'],
            'UD': ['10:25', '18:00'], 'US': ['11:30', '19:05'], 'VI': ['11:30', '20:05'],
            'XXX': ['00:00', '00:00']
        };

        const LOCATIONS = {
            'N1': 'Nomentano 1', 'N2': 'Nomentano 2', 'N3': 'Nomentano 3',
            'N4': 'Nomentano 4', 'N5': 'Nomentano 5', 'N6': 'Nomentano 6',
            'AFP1': 'Foro Italico', 'AFI': 'Foro Italico',
            '1': 'Teulada 1', '2': 'Teulada 2', '3': 'Teulada 3',
            '4': 'Teulada 4', '5': 'Teulada 5',
            'SR1': 'Saxa Rubra 1', 'SR2': 'Saxa Rubra 2', 'SR3': 'Saxa Rubra 3',
            'SR4': 'Saxa Rubra 4', 'SR5': 'Saxa Rubra 5 - Rai Sport',
            'RAN': 'Saxa Rubra - RAI NEWS', 'AUM': 'Montecitorio',
            'DISP': 'Disposizione', 'Disp.': 'Disposizione',
            'TdV': 'Teatro delle Vittorie', 'SE': 'Servizio Esterno',
            'MC': 'Media Center', 'QUA': 'Quarantena', 'QUB': 'Quarantena B',
            'SEN': 'Senato', 'ES06': 'Esterno 06', 'S9A': 'Studio 9A',
            'S09': 'Studio 09', 'S12': 'Studio 12', 'S03': 'Studio 03',
            'S04': 'Studio 04', 'S07': 'Studio 07', 'TG1': 'TG1',
            'TG2': 'TG2', 'TG3': 'TG3', 'OB': 'Outside Broadcast',
            'OB20': 'Outside Broadcast 20', 'OB30': 'Outside Broadcast 30',
            'OB41': 'Outside Broadcast 41', 'RT': 'Riposo Tecnico',
            '645': '645', '475': '475'
        };

        function log(message) {
            const debug = document.getElementById('debug');
            const timestamp = new Date().toLocaleTimeString();
            debug.textContent += `[${timestamp}] ${message}\n`;
            debug.scrollTop = debug.scrollHeight;
            console.log(message);
        }

        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('active', show);
        }

        async function extractTextFromPDF(file) {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
            let fullText = '';

            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const textContent = await page.getTextContent();
                
                const items = textContent.items.sort((a, b) => {
                    const yDiff = Math.abs(a.transform[5] - b.transform[5]);
                    if (yDiff > 5) {
                        return b.transform[5] - a.transform[5];
                    }
                    return a.transform[4] - b.transform[4];
                });
                
                let lastY = null;
                let lineText = '';
                
                items.forEach(item => {
                    const y = item.transform[5];
                    
                    if (lastY !== null && Math.abs(y - lastY) > 5) {
                        fullText += lineText + '\n';
                        lineText = '';
                    }
                    
                    lineText += item.str + ' ';
                    lastY = y;
                });
                
                fullText += lineText + '\n';
            }

            return fullText;
        }

        function findEmployeeLine(text, firstName, lastName) {
            const lines = text.split('\n');
            const searchNames = [
                `${lastName.toUpperCase()}, ${firstName.toUpperCase()}`,
                `${lastName.toUpperCase()},${firstName.toUpperCase()}`,
                lastName.toUpperCase()
            ];

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                for (const searchName of searchNames) {
                    if (line.includes(searchName)) {
                        log(`‚úì Found employee at line ${i}`);
                        return { index: i, line: line, lines: lines };
                    }
                }
            }
            return null;
        }

        function extractWeekDates(text) {
            const lines = text.split('\n');
            
            for (const line of lines) {
                const match = line.match(/(\d{2})\/(\d{2})\/(\d{4})\s+(\d{2})\/(\d{2})\/(\d{4})/);
                if (match) {
                    const startDay = parseInt(match[1]);
                    const startMonth = parseInt(match[2]);
                    const year = parseInt(match[3]);
                    
                    log(`‚úì Found week dates: ${match[0]}`);
                    return generateWeekDates(startDay, startMonth, year);
                }
            }
            
            return generateWeekDates(8, 12, 2025);
        }

        function generateWeekDates(day, month, year) {
            const dates = [];
            const startDate = new Date(year, month - 1, day);

            for (let i = 0; i < 7; i++) {
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                dates.push(date);
            }

            return dates;
        }

        function parseSchedule(text, firstName, lastName) {
            const employeeData = findEmployeeLine(text, firstName, lastName);
            
            if (!employeeData) {
                return { found: false, schedule: [] };
            }

            const weekDates = extractWeekDates(text);
            const schedule = [];
            
            // Get the line with the employee name - this line contains ALL the shifts!
            const nameLine = employeeData.lines[employeeData.index];
            log(`Name line: ${nameLine}`);
            
            // Split the line into tokens to process sequentially
            // Remove the employee name part first
            const dataPartMatch = nameLine.match(/[A-Z]+,\s*[A-Z]+\s+(.*)/);
            if (!dataPartMatch) {
                log('‚ùå Could not extract data part from name line');
                return { found: true, schedule: [] };
            }
            
            const dataPart = dataPartMatch[1];
            log(`Data part: ${dataPart}`);
            
            // Find all shift codes and their positions
            const shiftPattern = /'([A-Z*+0-9\s]{1,4})'/g;
            let match;
            const shiftsFound = [];
            
            while ((match = shiftPattern.exec(dataPart)) !== null) {
                const shiftCode = match[1].trim(); // Trim spaces inside quotes
                if (SHIFT_TIMES[shiftCode]) {
                    shiftsFound.push({
                        code: shiftCode,
                        position: match.index,
                        endPosition: match.index + match[0].length
                    });
                    log(`  Found shift code: '${shiftCode}'`);
                }
            }
            
            log(`‚úì Found ${shiftsFound.length} valid shift codes`);
            
            if (shiftsFound.length === 0) {
                log('‚ùå No shifts found on name line');
                return { found: true, schedule: [] };
            }
            
            // For each shift, extract its location
            shiftsFound.forEach((shift, dayIndex) => {
                if (dayIndex >= 7) return; // Only 7 days in a week
                
                // Get everything after this shift code until the next shift or end
                let afterShift;
                if (dayIndex < shiftsFound.length - 1) {
                    // Get text between this shift and the next shift
                    afterShift = dataPart.substring(shift.endPosition, shiftsFound[dayIndex + 1].position);
                } else {
                    // Last shift - get everything after it
                    afterShift = dataPart.substring(shift.endPosition);
                }
                
                log(`  After shift '${shift.code}': "${afterShift.trim()}"`);
                
                // Extract all tokens (words) after the shift
                const tokens = afterShift.trim().split(/\s+/).filter(t => t.length > 0);
                
                let location = 'SE'; // Default
                
                // Look through tokens to find the location
                // Skip: MFS, MNS, SE>, FS>, RCF>, and numbers like 95, 96
                for (const token of tokens) {
                    const cleaned = token.replace(/[>,<]/g, ''); // Remove arrows
                    
                    // Skip status codes
                    if (['MFS', 'MNS', 'SE', 'FS', 'RCF', 'XXX', 'RT'].includes(cleaned)) {
                        continue;
                    }
                    
                    // Skip day off codes (95, 96)
                    if (['95', '96'].includes(cleaned)) {
                        continue;
                    }
                    
                    // This should be the location
                    location = cleaned;
                    break;
                }
                
                log(`  Day ${dayIndex + 1}: ${shift.code} @ ${location}`);
                
                schedule.push({
                    date: weekDates[dayIndex],
                    shiftCode: shift.code,
                    location: location
                });
            });
            
            log(`‚úì Total shifts extracted: ${schedule.length}`);

            return { found: true, schedule: schedule };
        }

        function getLocationName(locationCode) {
            let cleanCode = locationCode.replace(/^OB-?/, '').replace(/[>\d]+$/, '');
            
            if (LOCATIONS[cleanCode]) return LOCATIONS[cleanCode];
            if (LOCATIONS[locationCode]) return LOCATIONS[locationCode];
            
            for (const [key, value] of Object.entries(LOCATIONS)) {
                if (locationCode.includes(key) || key.includes(locationCode)) {
                    return value;
                }
            }
            
            return locationCode;
        }

        function displayShifts(schedule) {
            const shiftsList = document.getElementById('shiftsList');
            shiftsList.innerHTML = '';

            schedule.forEach((shift, idx) => {
                const times = SHIFT_TIMES[shift.shiftCode];
                const locationName = getLocationName(shift.location);
                
                const div = document.createElement('div');
                div.className = 'shift-item';
                div.innerHTML = `
                    <strong>${shift.date.toLocaleDateString('it-IT', { weekday: 'long', day: '2-digit', month: '2-digit' })}</strong><br>
                    Turno: ${shift.shiftCode} (${times[0]} - ${times[1]})<br>
                    Luogo: ${locationName}
                `;
                shiftsList.appendChild(div);
            });

            document.getElementById('shiftsPreview').classList.add('active');
        }

        function generateICS(schedule, firstName, lastName) {
            let icsContent = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//RAI Shift Calendar//EN',
                'CALSCALE:GREGORIAN',
                'METHOD:PUBLISH',
                'X-WR-CALNAME:RAI Turni - ' + firstName + ' ' + lastName,
                'X-WR-TIMEZONE:Europe/Rome'
            ];

            schedule.forEach(shift => {
                const times = SHIFT_TIMES[shift.shiftCode];
                if (!times || shift.shiftCode === 'XXX') return;

                const [startHour, startMin] = times[0].split(':');
                const [endHour, endMin] = times[1].split(':');

                const startDate = new Date(shift.date);
                startDate.setHours(parseInt(startHour), parseInt(startMin), 0);

                let endDate = new Date(shift.date);
                endDate.setHours(parseInt(endHour), parseInt(endMin), 0);

                if (parseInt(endHour) < parseInt(startHour)) {
                    endDate.setDate(endDate.getDate() + 1);
                }

                const locationName = getLocationName(shift.location);
                const eventTitle = `${shift.shiftCode} - ${locationName}`;

                icsContent.push('BEGIN:VEVENT');
                icsContent.push(`DTSTART:${formatICSDate(startDate)}`);
                icsContent.push(`DTEND:${formatICSDate(endDate)}`);
                icsContent.push(`SUMMARY:${eventTitle}`);
                icsContent.push(`LOCATION:${locationName}`);
                icsContent.push(`DESCRIPTION:Turno ${shift.shiftCode}\\nOrario: ${times[0]} - ${times[1]}`);
                icsContent.push(`UID:${Date.now()}-${Math.random()}@rai-shifts`);
                icsContent.push(`DTSTAMP:${formatICSDate(new Date())}`);
                icsContent.push('END:VEVENT');
            });

            icsContent.push('END:VCALENDAR');
            return icsContent.join('\r\n');
        }

        function formatICSDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            return `${year}${month}${day}T${hours}${minutes}${seconds}`;
        }

        function downloadICS(content, firstName, lastName) {
            const blob = new Blob([content], { type: 'text/calendar;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `RAI_Turni_${firstName}_${lastName}.ics`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Extract button click handler
        document.getElementById('extractBtn').onclick = async function() {
            log('');
            log('='.repeat(50));
            log('üöÄ EXTRACT BUTTON CLICKED');
            
            const pdfFile = document.getElementById('pdfFile').files[0];
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();

            log(`üìÑ File: ${pdfFile ? pdfFile.name : 'NONE'}`);
            log(`üë§ Name: ${firstName} ${lastName}`);

            if (!pdfFile) {
                showStatus('‚ùå Seleziona un file PDF!', 'error');
                log('‚ùå No PDF file selected');
                return;
            }

            if (!firstName || !lastName) {
                showStatus('‚ùå Inserisci nome e cognome!', 'error');
                log('‚ùå Name fields empty');
                return;
            }

            try {
                showLoading(true);
                showStatus('', '');
                document.getElementById('shiftsPreview').classList.remove('active');

                log('üìñ Extracting PDF text...');
                const text = await extractTextFromPDF(pdfFile);
                log(`‚úì Extracted ${text.length} characters`);
                
                log('üîç Searching for employee...');
                const result = parseSchedule(text, firstName, lastName);

                if (!result.found) {
                    showStatus(`‚ùå Dipendente "${firstName} ${lastName}" non trovato`, 'error');
                    log('‚ùå Employee not found');
                    showLoading(false);
                    return;
                }

                if (result.schedule.length === 0) {
                    showStatus('‚ùå Nessun turno trovato', 'error');
                    log('‚ùå No shifts found');
                    showLoading(false);
                    return;
                }

                log(`‚úÖ SUCCESS! Found ${result.schedule.length} shifts`);
                extractedSchedule = result.schedule;
                currentFirstName = firstName;
                currentLastName = lastName;

                displayShifts(result.schedule);
                showStatus(`‚úì Trovati ${result.schedule.length} turni!`, 'success');
                showLoading(false);

            } catch (error) {
                log('üí• ERROR: ' + error.message);
                console.error(error);
                showStatus('‚ùå Errore: ' + error.message, 'error');
                showLoading(false);
            }
        };

        // Download button click handler
        document.getElementById('downloadBtn').onclick = function() {
            log('');
            log('üíæ DOWNLOAD BUTTON CLICKED');
            
            if (!extractedSchedule) {
                showStatus('‚ùå Nessun turno da scaricare!', 'error');
                return;
            }

            try {
                log('üìÖ Generating ICS...');
                const icsContent = generateICS(extractedSchedule, currentFirstName, currentLastName);
                log(`‚úì ICS generated (${icsContent.length} bytes)`);
                
                log('‚¨áÔ∏è Downloading...');
                downloadICS(icsContent, currentFirstName, currentLastName);
                log('‚úÖ Download complete!');
                showStatus('‚úì File scaricato con successo!', 'success');
            } catch (error) {
                log('üí• ERROR: ' + error.message);
                console.error(error);
                showStatus('‚ùå Errore nel download: ' + error.message, 'error');
            }
        };

        log('‚úì Page loaded successfully');
        log('‚úì Ready to process PDF files');
    </script>
</body>
</html>
