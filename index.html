import React, { useState } from 'react';
import { Calendar, Upload, Download, AlertCircle, CheckCircle } from 'lucide-react';

const RAIScheduleConverter = () => {
  const [file, setFile] = useState(null);
  const [employeeName, setEmployeeName] = useState('');
  const [status, setStatus] = useState('');
  const [error, setError] = useState('');
  const [schedule, setSchedule] = useState(null);
  const [processing, setProcessing] = useState(false);

  // Complete shift time mappings
  const shiftTimes = {
    '4o': ['05:55', '13:30'],
    '5o': ['05:55', '14:30'],
    '01': ['05:45', '14:20'],
    '05': ['05:55', '14:30'],
    '14': ['12:15', '20:50'],
    '57': ['11:25', '19:00'],
    '5T': ['13:00', '20:35'],
    '1M': ['09:30', '18:05'],
    '2E': ['11:25', '20:00'],
    '2Q': ['14:00', '22:35'],
    '3Z': ['07:30', '16:05'],
    '6E': ['05:30', '13:05'],
    '6L': ['12:00', '19:35'],
    '7N': ['15:25', '23:00'],
    'B1': ['05:50', '14:25'],
    'C': ['07:00', '15:35'],
    'C*': ['07:00', '14:35'],
    'Ce*': ['07:00', '14:35'],
    'D': ['08:00', '16:35'],
    'D*': ['08:00', '15:35'],
    'De*': ['08:00', '15:35'],
    'E': ['08:30', '17:05'],
    'E*': ['08:30', '16:05'],
    'EZ': ['10:25', '19:00'],
    'F': ['09:00', '17:35'],
    'F*': ['09:00', '16:35'],
    'Fe*': ['09:00', '16:35'],
    'F0': ['08:25', '17:00'],
    'FH': ['08:25', '16:00'],
    'G': ['10:00', '18:35'],
    'G*': ['10:00', '17:35'],
    'G+': ['11:00', '18:35'],
    'H': ['11:00', '19:30'],
    'I': ['12:45', '21:20'],
    'I*': ['12:45', '20:20'],
    'L': ['13:30', '22:05'],
    'L*': ['13:30', '21:05'],
    'L+': ['14:30', '22:05'],
    'M': ['15:00', '23:35'],
    'M*': ['15:00', '22:35'],
    'M+': ['16:00', '23:35'],
    'N': ['15:55', '00:30'],
    'N+': ['16:55', '00:30'],
    'N1': ['16:25', '01:00'],
    'O': ['16:55', '01:30'],
    'RC': ['05:30', '14:05'],
    'RG': ['12:00', '20:35'],
    'RU': ['05:00', '13:35'],
    'SR': ['10:45', '19:20'],
    'TC': ['06:30', '15:05'],
    'TD': ['06:30', '14:05'],
    'UD': ['10:25', '18:00'],
    'US': ['11:30', '19:05'],
    'VI': ['11:30', '20:05'],
    'XXX': ['00:00', '00:00']
  };

  // Location mappings
  const locations = {
    'N1': 'Nomentano 1',
    'N2': 'Nomentano 2',
    'N3': 'Nomentano 3',
    'N4': 'Nomentano 4',
    'N5': 'Nomentano 5',
    'N6': 'Nomentano 6',
    'AFP1': 'Foro Italico',
    'AFI': 'Foro Italico',
    '1': 'Teulada 1',
    '2': 'Teulada 2',
    '3': 'Teulada 3',
    '4': 'Teulada 4',
    '5': 'Teulada 5',
    'SR1': 'Saxa Rubra 1',
    'SR2': 'Saxa Rubra 2',
    'SR3': 'Saxa Rubra 3',
    'SR4': 'Saxa Rubra 4',
    'SR5': 'Saxa Rubra 5 - Rai Sport',
    'RAN': 'Saxa Rubra - RAI NEWS',
    'AUM': 'Montecitorio',
    'DISP': 'Disposizione',
    'Disp.': 'Disposizione',
    'TdV': 'Teatro delle Vittorie',
    'SE': 'Servizio Esterno',
    'MC': 'Media Center',
    'QUA': 'Quarantena',
    'QUB': 'Quarantena B',
    'SEN': 'Senato',
    'ES06': 'Esterno 06',
    'S9A': 'Studio 9A',
    'S09': 'Studio 09',
    'S12': 'Studio 12',
    'S03': 'Studio 03',
    'S04': 'Studio 04',
    'S07': 'Studio 07',
    'TG1': 'TG1',
    'TG2': 'TG2',
    'TG3': 'TG3'
  };

  const createEventTitle = (shift, location, obVan) => {
    let title = shift;
    
    if (location && locations[location]) {
      title += `, ${locations[location]}`;
    } else if (location) {
      title += `, ${location}`;
    }
    
    if (obVan) {
      title += `, OB${obVan}`;
    }
    
    return title;
  };

  const createICSFile = (scheduleData, startDate, employeeName) => {
    const events = [];
    
    scheduleData.forEach((dayData, index) => {
      if (!dayData || !dayData.shift || dayData.shift === 'XXX' || !shiftTimes[dayData.shift]) {
        return;
      }

      const date = new Date(startDate);
      date.setDate(date.getDate() + index);
      
      const [startTime, endTime] = shiftTimes[dayData.shift];
      const [startHour, startMin] = startTime.split(':');
      const [endHour, endMin] = endTime.split(':');

      const eventStart = new Date(date);
      eventStart.setHours(parseInt(startHour), parseInt(startMin), 0);

      const eventEnd = new Date(date);
      eventEnd.setHours(parseInt(endHour), parseInt(endMin), 0);
      
      if (parseInt(endHour) < parseInt(startHour)) {
        eventEnd.setDate(eventEnd.getDate() + 1);
      }

      const formatDate = (d) => {
        const year = d.getUTCFullYear();
        const month = String(d.getUTCMonth() + 1).padStart(2, '0');
        const day = String(d.getUTCDate()).padStart(2, '0');
        const hours = String(d.getUTCHours()).padStart(2, '0');
        const minutes = String(d.getUTCMinutes()).padStart(2, '0');
        const seconds = String(d.getUTCSeconds()).padStart(2, '0');
        return `${year}${month}${day}T${hours}${minutes}${seconds}Z`;
      };

      const title = createEventTitle(dayData.shift, dayData.location, dayData.obVan);
      const locationText = dayData.location && locations[dayData.location] ? locations[dayData.location] : dayData.location;
      const description = `Turno ${dayData.shift} (${startTime}-${endTime})${
        locationText ? '\\nLuogo: ' + locationText : ''
      }${dayData.obVan ? '\\nOB Van: ' + dayData.obVan : ''}`;

      events.push({
        start: formatDate(eventStart),
        end: formatDate(eventEnd),
        summary: title,
        description: description
      });
    });

    const lines = [
      'BEGIN:VCALENDAR',
      'VERSION:2.0',
      'PRODID:-//RAI Schedule Converter//IT',
      'CALSCALE:GREGORIAN',
      'METHOD:PUBLISH',
      'X-WR-CALNAME:Turni ' + employeeName,
      'X-WR-TIMEZONE:Europe/Rome'
    ];

    events.forEach(event => {
      const uid = Date.now() + '-' + Math.random().toString(36).substr(2, 9);
      lines.push('BEGIN:VEVENT');
      lines.push('DTSTART:' + event.start);
      lines.push('DTEND:' + event.end);
      lines.push('SUMMARY:' + event.summary);
      lines.push('DESCRIPTION:' + event.description);
      lines.push('UID:' + uid + '@rai-schedule');
      lines.push('STATUS:CONFIRMED');
      lines.push('END:VEVENT');
    });

    lines.push('END:VCALENDAR');
    return lines.join('\r\n');
  };

  const handleFileUpload = (e) => {
    const uploadedFile = e.target.files[0];
    if (!uploadedFile) return;

    if (uploadedFile.type !== 'application/pdf') {
      setError('Per favore carica un file PDF');
      return;
    }

    setFile(uploadedFile);
    setError('');
    setStatus('');
  };

  const processSchedule = async () => {
    if (!file || !employeeName.trim()) {
      setError('Per favore carica un file e inserisci il nome del dipendente');
      return;
    }

    setProcessing(true);
    setError('');
    setStatus('Elaborazione in corso...');

    try {
      const arrayBuffer = await file.arrayBuffer();
      const bytes = new Uint8Array(arrayBuffer);
      
      // Convert to base64 using a more efficient method
      const base64 = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const dataUrl = reader.result;
          const base64String = dataUrl.split(',')[1];
          resolve(base64String);
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
      
      setStatus('Estrazione programma dal PDF...');
      
      const response = await fetch("https://api.anthropic.com/v1/messages", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          model: "claude-sonnet-4-20250514",
          max_tokens: 2000,
          messages: [
            {
              role: "user",
              content: [
                {
                  type: "document",
                  source: {
                    type: "base64",
                    media_type: "application/pdf",
                    data: base64
                  }
                },
                {
                  type: "text",
                  text: `Cerca nel documento un dipendente il cui nome contiene le parole: "${employeeName}". Il nome può essere in formato "COGNOME, NOME" o in qualsiasi ordine. Trova la corrispondenza migliore anche se l'ordine è diverso o mancano virgole.

Estrai la riga completa del suo programma per 7 giorni (lunedì-domenica).

Per ogni giorno, estrai:
1. Il codice turno (tra apici singoli come 'H', 'D', 'F*', ecc.)
2. Il codice location che appare DOPO il codice turno (come N3, AFP1, SR4, SE, Disp., MC, ecc.)
3. Il numero OB van se presente (da codici come OB41 estrai solo 41, da OB20 estrai 20)

IMPORTANTE: I codici location possono essere:
- Codici semplici: N3, N4, AFP1, SR4, MC, SE
- Parole: Disp., AUM, SEN
- Con numeri OB: OB41 significa location "OB4" e van "1"

Rispondi SOLO con un JSON array di 7 oggetti:
[{"shift":"H","location":"OB4","obVan":"1"},{"shift":"F*","location":"Disp.","obVan":""},...}]

Se un giorno non ha turno: {"shift":"XXX","location":"","obVan":""}
Se non c'è location: {"location":"","obVan":""}

NON aggiungere altro testo, SOLO il JSON array.`
                }
              ]
            }
          ]
        })
      });

      const data = await response.json();
      
      if (!data.content || data.content.length === 0) {
        throw new Error('Impossibile estrarre il programma dal PDF');
      }

      let extractedText = '';
      for (const item of data.content) {
        if (item.type === "text") {
          extractedText += item.text;
        }
      }

      let jsonText = extractedText.trim();
      jsonText = jsonText.replace(/```json\n?/g, '').replace(/```\n?/g, '');
      
      const scheduleData = JSON.parse(jsonText);
      
      if (!Array.isArray(scheduleData) || scheduleData.length !== 7) {
        throw new Error(`Formato non valido. Trovati ${scheduleData.length} giorni invece di 7.`);
      }

      const weekStart = new Date('2025-12-08');

      setSchedule({ data: scheduleData, weekStart });
      setStatus('Programma estratto con successo!');
      setProcessing(false);

    } catch (err) {
      setError(`Errore: ${err.message}`);
      setStatus('');
      setProcessing(false);
    }
  };

  const downloadICS = () => {
    if (!schedule) return;

    const icsContent = createICSFile(schedule.data, schedule.weekStart, employeeName);
    const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `turni_${employeeName.replace(/\s+/g, '_').replace(/,/g, '')}.ics`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 p-4 sm:p-6">
      <div className="max-w-4xl mx-auto">
        {/* Header */}
        <div className="text-center mb-8 pt-8">
          <div className="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-blue-500 to-purple-600 rounded-2xl mb-4 shadow-lg">
            <Calendar className="w-8 h-8 text-white" />
          </div>
          <h1 className="text-4xl sm:text-5xl font-bold text-white mb-3">
            Convertitore Turni RAI
          </h1>
          <p className="text-purple-200 text-lg">
            Trasforma il tuo PDF in eventi calendario
          </p>
        </div>

        <div className="bg-white/95 backdrop-blur-lg rounded-3xl shadow-2xl p-6 sm:p-8 border border-white/20">
          <div className="space-y-6">
            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                Nome e Cognome del Dipendente
              </label>
              <input
                type="text"
                value={employeeName}
                onChange={(e) => setEmployeeName(e.target.value)}
                placeholder="es. Mario Rossi"
                className="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all text-gray-800 placeholder-gray-400"
              />
              <p className="text-xs text-gray-500 mt-2 ml-1">
                Puoi scrivere il nome in qualsiasi formato
              </p>
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-2">
                File PDF del Programma
              </label>
              <div className="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center hover:border-purple-500 hover:bg-purple-50/50 transition-all cursor-pointer group">
                <input
                  type="file"
                  accept=".pdf"
                  onChange={handleFileUpload}
                  className="hidden"
                  id="file-upload"
                />
                <label
                  htmlFor="file-upload"
                  className="cursor-pointer flex flex-col items-center"
                >
                  <div className="w-16 h-16 bg-gradient-to-br from-purple-100 to-blue-100 rounded-2xl flex items-center justify-center mb-3 group-hover:scale-110 transition-transform">
                    <Upload className="w-8 h-8 text-purple-600" />
                  </div>
                  <span className="text-sm font-medium text-gray-700">
                    {file ? (
                      <span className="text-purple-600">{file.name}</span>
                    ) : (
                      'Clicca per caricare il PDF'
                    )}
                  </span>
                  {!file && (
                    <span className="text-xs text-gray-400 mt-1">
                      o trascina qui il file
                    </span>
                  )}
                </label>
              </div>
            </div>

            <button
              onClick={processSchedule}
              disabled={!file || !employeeName || processing}
              className="w-full bg-gradient-to-r from-purple-600 to-blue-600 text-white py-4 rounded-xl font-semibold text-lg hover:from-purple-700 hover:to-blue-700 disabled:from-gray-300 disabled:to-gray-400 disabled:cursor-not-allowed transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 disabled:transform-none"
            >
              {processing ? (
                <span className="flex items-center justify-center gap-2">
                  <div className="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                  Elaborazione in corso...
                </span>
              ) : (
                'Elabora Programma'
              )}
            </button>

            {status && (
              <div className="flex items-center gap-3 p-4 bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-xl">
                <div className="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center flex-shrink-0">
                  <CheckCircle className="w-6 h-6 text-white" />
                </div>
                <span className="text-green-800 font-medium">{status}</span>
              </div>
            )}

            {error && (
              <div className="flex items-center gap-3 p-4 bg-gradient-to-r from-red-50 to-rose-50 border-2 border-red-200 rounded-xl">
                <div className="w-10 h-10 bg-red-500 rounded-full flex items-center justify-center flex-shrink-0">
                  <AlertCircle className="w-6 h-6 text-white" />
                </div>
                <span className="text-red-800 font-medium">{error}</span>
              </div>
            )}

            {schedule && (
              <div className="border-2 border-purple-200 rounded-2xl p-6 bg-gradient-to-br from-purple-50 to-blue-50">
                <h3 className="font-bold text-xl text-gray-800 mb-4">
                  Programma Estratto
                </h3>
                <div className="space-y-3 mb-6">
                  {['Lunedì', 'Martedì', 'Mercoledì', 'Giovedì', 'Venerdì', 'Sabato', 'Domenica'].map((day, i) => {
                    const dayData = schedule.data[i];
                    if (!dayData || dayData.shift === 'XXX') {
                      return (
                        <div key={day} className="flex items-center justify-between p-4 bg-white rounded-xl shadow-sm border border-gray-100">
                          <span className="font-semibold text-gray-700">{day}</span>
                          <span className="text-gray-400 text-sm">Riposo</span>
                        </div>
                      );
                    }
                    
                    const times = shiftTimes[dayData.shift] || ['--:--', '--:--'];
                    const title = createEventTitle(dayData.shift, dayData.location, dayData.obVan);
                    
                    return (
                      <div key={day} className="flex items-center justify-between p-4 bg-gradient-to-r from-purple-500 to-blue-500 rounded-xl shadow-md text-white">
                        <div className="flex-1">
                          <div className="font-bold text-sm opacity-90 mb-1">{day}</div>
                          <div className="text-sm font-semibold">{title}</div>
                        </div>
                        <div className="text-right ml-4">
                          <div className="text-sm font-bold bg-white/20 px-3 py-1 rounded-lg backdrop-blur-sm">
                            {times[0]} - {times[1]}
                          </div>
                        </div>
                      </div>
                    );
                  })}
                </div>
                <button
                  onClick={downloadICS}
                  className="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white py-4 rounded-xl font-bold text-lg hover:from-green-600 hover:to-emerald-700 flex items-center justify-center gap-3 shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-0.5"
                >
                  <Download className="w-6 h-6" />
                  Scarica File Calendario (.ics)
                </button>
                <p className="text-xs text-center text-gray-500 mt-3">
                  Compatibile con Google Calendar, Apple Calendar, Outlook e altri
                </p>
              </div>
            )}
          </div>

          <div className="mt-8 p-6 bg-gradient-to-br from-gray-50 to-gray-100 rounded-2xl border border-gray-200">
            <h3 className="font-bold text-gray-800 mb-3 text-lg">Come usare</h3>
            <ol className="text-sm text-gray-600 space-y-2 ml-5">
              <li className="flex items-start gap-2">
                <span className="font-bold text-purple-600 min-w-[1.5rem]">1.</span>
                <span>Scrivi il nome del dipendente in qualsiasi formato</span>
              </li>
              <li className="flex items-start gap-2">
                <span className="font-bold text-purple-600 min-w-[1.5rem]">2.</span>
                <span>Carica il file PDF del programma settimanale</span>
              </li>
              <li className="flex items-start gap-2">
                <span className="font-bold text-purple-600 min-w-[1.5rem]">3.</span>
                <span>Clicca su "Elabora Programma"</span>
              </li>
              <li className="flex items-start gap-2">
                <span className="font-bold text-purple-600 min-w-[1.5rem]">4.</span>
                <span>Controlla il programma estratto</span>
              </li>
              <li className="flex items-start gap-2">
                <span className="font-bold text-purple-600 min-w-[1.5rem]">5.</span>
                <span>Scarica il file e importalo nella tua app calendario preferita</span>
              </li>
            </ol>
            <div className="mt-4 p-4 bg-white rounded-xl border border-purple-200">
              <p className="font-semibold text-gray-700 mb-2 text-sm">Il file includerà</p>
              <ul className="text-xs text-gray-600 space-y-1.5 ml-4">
                <li className="flex items-center gap-2">
                  <span className="w-1.5 h-1.5 bg-purple-500 rounded-full"></span>
                  Codice turno e orari precisi
                </li>
                <li className="flex items-center gap-2">
                  <span className="w-1.5 h-1.5 bg-purple-500 rounded-full"></span>
                  Nome della location (es. Nomentano 3, Foro Italico)
                </li>
                <li className="flex items-center gap-2">
                  <span className="w-1.5 h-1.5 bg-purple-500 rounded-full"></span>
                  Numero OB van se applicabile
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default RAIScheduleConverter;
